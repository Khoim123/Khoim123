--[[
    Fluent Aimbot Pro - Optimized Version
    Features: Bug fixes, performance improvements, and better code structure.
]]

--==============================================================================
-- Services & Libraries
--==============================================================================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local Camera = workspace.CurrentCamera

-- Load Fluent Library
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

--==============================================================================
-- Constants & Configuration
--==============================================================================
local CHARACTER_LOAD_WAIT = 0.5
local UPDATE_FREQUENCY = 0 -- 0 means every frame, higher values are less frequent but less responsive. Heartbeat is best for this.

--==============================================================================
-- Variables
--==============================================================================
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local playerRoot = character:WaitForChild("HumanoidRootPart", CHARACTER_LOAD_WAIT)
local playerHumanoid = character:WaitForChild("Humanoid", CHARACTER_LOAD_WAIT)

-- Aimbot Settings
local AimbotDistance = 50
local Smoothness = 0.5
local CharacterTilt = false
local AimbotEnabled = false
local SelectedPlayers = {} -- Stores UserId of selected targets
local aimbotConnection

--==============================================================================
-- Core Functions
--==============================================================================

-- Character Management
local function onCharacterAdded(newChar)
    character = newChar
    -- Use WaitForChild for safety, preventing nil errors
    playerRoot = newChar:WaitForChild("HumanoidRootPart", CHARACTER_LOAD_WAIT)
    playerHumanoid = newChar:WaitForChild("Humanoid", CHARACTER_LOAD_WAIT)
end

player.CharacterAdded:Connect(onCharacterAdded)

-- Helper function to get the current character's root part and humanoid
local function getPlayerParts()
    if not character or not character.Parent then
        character = player.Character
        if not character then return nil, nil end
    end
    -- Cache these to avoid repeated FindFirstChild calls
    local root = character:FindFirstChild("HumanoidRootPart")
    local hum = character:FindFirstChild("Humanoid")
    return root, hum
end

local function isValidTarget(targetPlayer)
    if not targetPlayer or targetPlayer == player then return false end
    -- If no players are selected, target everyone. Otherwise, target only selected players.
    return next(SelectedPlayers) == nil or SelectedPlayers[targetPlayer.UserId]
end

local function getNearestCharacter()
    if not AimbotEnabled then return nil end
    
    local playerRoot, playerHumanoid = getPlayerParts()
    if not playerRoot or not playerHumanoid or playerHumanoid.Health <= 0 then return nil end
    
    local closestChar, shortestDist = nil, math.huge
    local playerPosition = playerRoot.Position
    
    for _, targetPlayer in ipairs(Players:GetPlayers()) do
        if isValidTarget(targetPlayer) and targetPlayer.Character then
            local targetChar = targetPlayer.Character
            local targetHumanoid = targetChar:FindFirstChildOfClass("Humanoid")
            local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
            
            if targetRoot and targetHumanoid and targetHumanoid.Health > 0 then
                local dist = (playerPosition - targetRoot.Position).Magnitude
                if dist < shortestDist and dist <= AimbotDistance then
                    shortestDist = dist
                    closestChar = targetChar
                end
            end
        end
    end
    
    return closestChar
end

local function aimAtTarget(target)
    local playerRoot, playerHumanoid = getPlayerParts()
    if not playerRoot or not playerHumanoid or playerHumanoid.Health <= 0 then return end
    
    local targetRoot = target:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end
    
    local targetPos = targetRoot.Position
    local lookAtPosition
    
    if CharacterTilt then
        -- Aim at the center of the target's body
        lookAtPosition = targetPos
    else
        -- Aim only on the X and Z axes (horizontal plane)
        lookAtPosition = Vector3.new(targetPos.X, playerRoot.Position.Y, targetPos.Z)
    end
    
    -- Calculate the desired CFrame
    local goalCFrame = CFrame.new(playerRoot.Position, lookAtPosition)
    
    -- Apply smoothing using Lerp
    local currentCFrame = playerRoot.CFrame
    local smoothedCFrame = currentCFrame:Lerp(goalCFrame, Smoothness)
    
    playerRoot.CFrame = smoothedCFrame
end

local function toggleAimbot(state)
    AimbotEnabled = state
    
    if aimbotConnection then
        aimbotConnection:Disconnect()
        aimbotConnection = nil
    end
    
    if state then
        aimbotConnection = RunService.Heartbeat:Connect(function()
            local nearestChar = getNearestCharacter()
            if nearestChar then
                aimAtTarget(nearestChar)
            end
        end)
    end
end

--==============================================================================
-- UI Creation & Management
--==============================================================================
local Window = Fluent:CreateWindow({
    Title = "Aimbot Pro",
    SubTitle = "Mobile Optimized",
    TabWidth = 160,
    Size = UDim2.fromOffset(520, 420),
    Acrylic = true,
    Theme = "Darker",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Aimbot", Icon = "crosshair" }),
    Players = Window:AddTab({ Title = "NgÆ°á»i chÆ¡i", Icon = "users" }),
    Settings = Window:AddTab({ Title = "CÃ i Ä‘áº·t", Icon = "settings" })
}

-- Main Tab
local MainSection = Tabs.Main:AddSection("Äiá»u khiá»ƒn Aimbot")

local AimbotToggle = Tabs.Main:AddToggle("AimbotEnabled", {
    Title = "Báº­t Aimbot",
    Description = "KÃ­ch hoáº¡t/Táº¯t aimbot",
    Default = false,
    Callback = function(value)
        toggleAimbot(value)
        Fluent:Notify({
            Title = "Aimbot",
            Content = value and "ÄÃ£ Báº¬T aimbot" or "ÄÃ£ Táº®T aimbot",
            Duration = 2
        })
    end
})

local DistanceSlider = Tabs.Main:AddSlider("AimbotDistance", {
    Title = "Khoáº£ng cÃ¡ch ngáº¯m",
    Description = "Táº§m xa tá»‘i Ä‘a (studs)",
    Default = 50,
    Min = 1,
    Max = 10000,
    Rounding = 0,
    Callback = function(value)
        AimbotDistance = value
    end
})

local SmoothnessSlider = Tabs.Main:AddSlider("Smoothness", {
    Title = "Äá»™ mÆ°á»£t",
    Description = "Tá»‘c Ä‘á»™ xoay camera (cao hÆ¡n = mÆ°á»£t hÆ¡n)",
    Default = 0.5,
    Min = 0.05,
    Max = 1,
    Rounding = 2,
    Callback = function(value)
        Smoothness = value
    end
})

local TiltToggle = Tabs.Main:AddToggle("CharacterTilt", {
    Title = "Ngáº¯m theo chiá»u dá»c",
    Description = "Báº­t Ä‘á»ƒ ngáº¯m cáº£ trá»¥c Y (lÃªn/xuá»‘ng)",
    Default = false,
    Callback = function(value)
        CharacterTilt = value
    end
})

-- Players Tab
local PlayersSection = Tabs.Players:AddSection("Quáº£n lÃ½ má»¥c tiÃªu")

local PlayerList = Tabs.Players:AddParagraph({
    Title = "Tráº¡ng thÃ¡i má»¥c tiÃªu",
    Content = "Äang táº£i..."
})

local function updatePlayerListStatus()
    local playerCount = #Players:GetPlayers() - 1 -- Exclude self
    local selectedCount = 0
    for _ in pairs(SelectedPlayers) do
        selectedCount = selectedCount + 1
    end
    
    local statusText
    if selectedCount == 0 then
        statusText = "ChÆ°a chá»n má»¥c tiÃªu cá»¥ thá»ƒ (Sáº½ ngáº¯m táº¥t cáº£)"
    else
        statusText = string.format("ÄÃ£ chá»n %d má»¥c tiÃªu", selectedCount)
    end

    local content = string.format(
        "Tá»•ng sá»‘ ngÆ°á»i chÆ¡i khÃ¡c: %d\n%s",
        playerCount,
        statusText
    )
    
    PlayerList:SetDesc(content)
end

local PlayerDropdown = Tabs.Players:AddDropdown("PlayerSelector", {
    Title = "Chá»n má»¥c tiÃªu",
    Description = "Chá»n ngÆ°á»i chÆ¡i Ä‘á»ƒ nháº¯m Ä‘áº¿n (Bá» trá»‘ng Ä‘á»ƒ ngáº¯m táº¥t cáº£)",
    Values = {},
    Multi = true,
    Default = {},
    Callback = function(values) -- 'values' is an array of selected names, e.g., {"Player1", "Player2"}
        SelectedPlayers = {}
        for _, playerName in ipairs(values) do
            local targetPlayer = Players:FindFirstChild(playerName)
            if targetPlayer then
                SelectedPlayers[targetPlayer.UserId] = true
            end
        end
        updatePlayerListStatus()
    end
})

local function refreshPlayerDropdown()
    local playerNames = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player then
            table.insert(playerNames, p.Name)
        end
    end
    PlayerDropdown:SetValues(playerNames)
end

Tabs.Players:AddButton({
    Title = "LÃ m má»›i danh sÃ¡ch",
    Description = "Cáº­p nháº­t danh sÃ¡ch ngÆ°á»i chÆ¡i",
    Callback = function()
        refreshPlayerDropdown()
        updatePlayerListStatus()
        Fluent:Notify({ Title = "LÃ m má»›i", Content = "ÄÃ£ cáº­p nháº­t danh sÃ¡ch", Duration = 2 })
    end
})

Tabs.Players:AddButton({
    Title = "Bá» chá»n táº¥t cáº£",
    Description = "XÃ³a táº¥t cáº£ má»¥c tiÃªu Ä‘Ã£ chá»n",
    Callback = function()
        SelectedPlayers = {}
        -- Important: Update the dropdown UI to reflect the change
        PlayerDropdown:SetValues({})
        refreshPlayerDropdown() -- Repopulate the dropdown
        PlayerDropdown:SetValue({}) -- Clear the selection in the UI
        updatePlayerListStatus()
        Fluent:Notify({ Title = "ÄÃ£ xÃ³a", Content = "Bá» chá»n táº¥t cáº£ ngÆ°á»i chÆ¡i", Duration = 2 })
    end
})

-- Settings Tab
local SettingsSection = Tabs.Settings:AddSection("Cáº¥u hÃ¬nh")

Tabs.Settings:AddButton({
    Title = "Reset vá» máº·c Ä‘á»‹nh",
    Description = "Äáº·t láº¡i táº¥t cáº£ cÃ i Ä‘áº·t",
    Callback = function()
        DistanceSlider:SetValue(50)
        SmoothnessSlider:SetValue(0.5)
        TiltToggle:SetValue(false)
        AimbotToggle:SetValue(false)
        SelectedPlayers = {}
        refreshPlayerDropdown()
        updatePlayerListStatus()
        Fluent:Notify({ Title = "Reset", Content = "ÄÃ£ Ä‘áº·t láº¡i táº¥t cáº£ cÃ i Ä‘áº·t", Duration = 3 })
    end
})

Tabs.Settings:AddParagraph({
    Title = "ThÃ´ng tin",
    Content = "PhiÃªn báº£n: 2.1 (Tá»‘i Æ°u)\nTá»‘i Æ°u cho Mobile\nHá»— trá»£ Fluent UI"
})

--==============================================================================
-- Floating Toggle Button
--==============================================================================
local ToggleButton = Instance.new("ScreenGui")
ToggleButton.Name = "AimbotToggle"
ToggleButton.ResetOnSpawn = false
ToggleButton.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- GUI Protection
local ParentGui = gethui or (syn and syn.protect_gui and function(gui) syn.protect_gui(gui) return CoreGui end) or function(gui) return CoreGui end
ToggleButton.Parent = ParentGui(ToggleButton)

local ToggleFrame = Instance.new("Frame")
ToggleFrame.Size = UDim2.new(0, 55, 0, 55)
ToggleFrame.Position = UDim2.new(0, 15, 0.5, -27)
ToggleFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
ToggleFrame.BorderSizePixel = 0
ToggleFrame.Parent = ToggleButton

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = ToggleFrame

local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(100, 100, 100)
UIStroke.Thickness = 2
UIStroke.Parent = ToggleFrame

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(1, 0, 1, 0)
ToggleBtn.BackgroundTransparency = 1
ToggleBtn.Text = "ðŸŽ¯"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 26
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Parent = ToggleFrame

-- Dragging functionality
local dragging, dragStart, startPos

ToggleFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = ToggleFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

ToggleFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        ToggleFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Toggle Click
local guiVisible = true
ToggleBtn.MouseButton1Click:Connect(function()
    guiVisible = not guiVisible
    Window:Minimize()
    
    local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local targetColor = guiVisible and Color3.fromRGB(40, 40, 40) or Color3.fromRGB(60, 60, 60)
    TweenService:Create(ToggleFrame, tweenInfo, { BackgroundColor3 = targetColor }):Play()
end)

--==============================================================================
-- Initialization & Event Connections
--==============================================================================

-- Auto Update Player List
Players.PlayerAdded:Connect(refreshPlayerDropdown)
Players.PlayerRemoving:Connect(function(leftPlayer)
    SelectedPlayers[leftPlayer.UserId] = nil
    updatePlayerListStatus()
end)

-- Initial setup
refreshPlayerDropdown()
updatePlayerListStatus()

Fluent:Notify({
    Title = "Aimbot Pro",
    Content = "GUI Ä‘Ã£ táº£i thÃ nh cÃ´ng! (PhiÃªn báº£n tá»‘i Æ°u)",
    Duration = 4
})

warn("âœ… Fluent Aimbot GUI (Optimized) loaded!")